import { mock, mockDeep } from 'jest-mock-extended';
import { nanoid } from 'nanoid';
import Player from './lib/Player';
export function createConversationForTesting(params) {
    return {
        id: params?.conversationID || nanoid(),
        occupants: [],
        topic: params?.conversationTopic || nanoid(),
        type: 'ConversationArea',
    };
}
export function defaultLocation() {
    return { x: 0, y: 0, moving: false, rotation: 'front', interactableID: undefined };
}
export function clearEmittedEvents(mockEmitter, eventName) {
    if (!eventName) {
        mockEmitter.emit.mock.calls = [];
    }
    else {
        mockEmitter.emit.mock.calls = mockEmitter.emit.mock.calls.filter(eachCall => eachCall[0] !== eventName);
    }
}
export function getLastEmittedEvent(emitter, eventName, howFarBack = 0) {
    const { calls } = emitter.emit.mock;
    let nCallsToSkip = howFarBack;
    for (let i = calls.length - 1; i >= 0; i--) {
        if (calls[i][0] === eventName) {
            if (nCallsToSkip === 0) {
                const param = calls[i][1];
                return param;
            }
            nCallsToSkip--;
        }
    }
    throw new Error(`No ${eventName} could be found as emitted on this socket`);
}
export function extractSessionToken(player) {
    return getLastEmittedEvent(player.socket, 'initialize').sessionToken;
}
export function getEventListener(mockSocket, eventName) {
    const ret = mockSocket.on.mock.calls.find(eachCall => eachCall[0] === eventName);
    if (ret) {
        const param = ret[1];
        if (param) {
            return param;
        }
    }
    throw new Error(`No event listener found for event ${eventName}`);
}
export class MockedPlayer {
    socket;
    socketToRoomMock;
    userName;
    townID;
    player;
    constructor(socket, socketToRoomMock, userName, townID, player) {
        this.socket = socket;
        this.socketToRoomMock = socketToRoomMock;
        this.userName = userName;
        this.townID = townID;
        this.player = player;
    }
    moveTo(x, y, rotation = 'front', moving = false) {
        const onMovementListener = getEventListener(this.socket, 'playerMovement');
        onMovementListener({ x, y, rotation, moving });
    }
}
export function mockPlayer(townID) {
    const socket = mockDeep();
    const userName = nanoid();
    socket.handshake.auth = { userName, townID };
    const socketToRoomMock = mock();
    socket.to.mockImplementation((room) => {
        if (townID === room) {
            return socketToRoomMock;
        }
        throw new Error(`Tried to broadcast to ${room} but this player is in ${townID}`);
    });
    return new MockedPlayer(socket, socketToRoomMock, userName, townID, undefined);
}
export function createPlayerForTesting() {
    return new Player(`username${nanoid()}`, mock());
}
export function expectArraysToContainSameMembers(actual, expected) {
    expect(actual.length).toBe(expected.length);
    expected.forEach(expectedVal => expect(actual.find(actualVal => actualVal === expectedVal)).toBeDefined());
}
export function isViewingArea(interactable) {
    return 'isPlaying' in interactable;
}
export function isConversationArea(interactable) {
    return 'topic' in interactable;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGVzdFV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL1Rlc3RVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBYSxNQUFNLG9CQUFvQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFTaEMsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFDO0FBb0JsQyxNQUFNLFVBQVUsNEJBQTRCLENBQUMsTUFJNUM7SUFDQyxPQUFPO1FBQ0wsRUFBRSxFQUFFLE1BQU0sRUFBRSxjQUFjLElBQUksTUFBTSxFQUFFO1FBQ3RDLFNBQVMsRUFBRSxFQUFFO1FBQ2IsS0FBSyxFQUFFLE1BQU0sRUFBRSxpQkFBaUIsSUFBSSxNQUFNLEVBQUU7UUFDNUMsSUFBSSxFQUFFLGtCQUFrQjtLQUN6QixDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sVUFBVSxlQUFlO0lBQzdCLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxTQUFTLEVBQUUsQ0FBQztBQUNyRixDQUFDO0FBWUQsTUFBTSxVQUFVLGtCQUFrQixDQUNoQyxXQUFtRSxFQUNuRSxTQUFjO0lBRWQsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2YsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztJQUNuQyxDQUFDO1NBQU0sQ0FBQztRQUNOLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUM5RCxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLENBQ3RDLENBQUM7SUFD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